(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const t of o.addedNodes)t.tagName==="LINK"&&t.rel==="modulepreload"&&s(t)}).observe(document,{childList:!0,subtree:!0});function i(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=i(n);fetch(n.href,o)}})();const h="https://generateplan-gm5nfzzzwa-de.a.run.app",b="https://downloaddocx-gm5nfzzzwa-de.a.run.app";document.addEventListener("DOMContentLoaded",function(){"serviceWorker"in navigator&&(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&navigator.serviceWorker.getRegistrations().then(function(t){for(let r of t)r.unregister(),console.log("Service Worker 已註銷，確保載入最新版本 (localhost環境)。")});const c=document.getElementById("lesson-plan-form"),e=document.getElementById("result");let i;function s(t){const r=document.getElementById("progress-fill"),d=document.getElementById("progress-percent");r&&d&&(r.style.width=t+"%",d.textContent=Math.round(t)+"%")}function n(){let t=0;s(0),i=setInterval(()=>{t<30?t+=Math.random()*5:t<70?t+=Math.random()*2:t<95&&(t+=Math.random()*.5),t>98&&(t=98),s(t)},300)}function o(){clearInterval(i),s(100),setTimeout(()=>{document.getElementById("progress-container").style.display="none"},500)}c.addEventListener("submit",function(t){t.preventDefault();const r=c.querySelector('button[type="submit"]');r.disabled=!0,r.style.opacity="0.5",r.style.cursor="not-allowed";const d=document.getElementById("subject").value,m=document.getElementById("grade").value,y=document.getElementById("unit").value,g=document.getElementById("details").value,u=document.getElementById("progress-container");u&&(u.style.display="block",u.scrollIntoView({behavior:"smooth",block:"center"})),e&&(e.style.display="none",e.innerHTML=""),n(),fetch(h,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject:d,grade:m,unit:y,details:g})}).then(l=>l.json()).then(l=>{if(o(),l.success){const p=new DOMParser().parseFromString(l.plan,"text/html"),f=p.querySelector("h3");f&&f.classList.add("lesson-plan-title"),e.innerHTML=p.body.innerHTML,e.style.display="block";const a=document.createElement("button");a.textContent="下載 Word 檔案",a.id="downloadBtn",a.onclick=()=>L(l.html_content),e.appendChild(a)}else e.style.display="block",e.innerHTML=`<p>生成教案時出錯：${l.error}</p>`;r.disabled=!1,r.style.opacity="1",r.style.cursor="pointer"}).catch(l=>{o(),e.style.display="block",e.innerHTML=`<p>請求出錯：${l}</p>`,r.disabled=!1,r.style.opacity="1",r.style.cursor="pointer"})})});function L(c){fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({html_content:c})}).then(e=>e.blob()).then(e=>{const i=window.URL.createObjectURL(e),s=document.createElement("a");s.style.display="none",s.href=i,s.download="lesson_plan.docx",document.body.appendChild(s),s.click(),window.URL.revokeObjectURL(i)}).catch(e=>{console.error("Error downloading file:",e)})}
