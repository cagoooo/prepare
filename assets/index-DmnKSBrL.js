(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))l(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const e of r.addedNodes)e.tagName==="LINK"&&e.rel==="modulepreload"&&l(e)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function l(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();const h="https://generateplan-gm5nfzzzwa-de.a.run.app",b="https://downloaddocx-gm5nfzzzwa-de.a.run.app";document.addEventListener("DOMContentLoaded",function(){"serviceWorker"in navigator&&(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&navigator.serviceWorker.getRegistrations().then(function(e){for(let o of e)o.unregister(),console.log("Service Worker 已註銷，確保載入最新版本 (localhost環境)。")});const d=document.getElementById("lesson-plan-form"),t=document.getElementById("result");let s;function l(e){const o=document.getElementById("progress-fill"),c=document.getElementById("progress-percent");o&&c&&(o.style.width=e+"%",c.textContent=Math.round(e)+"%")}function n(){let e=0;l(0),s=setInterval(()=>{e<30?e+=Math.random()*5:e<70?e+=Math.random()*2:e<95&&(e+=Math.random()*.5),e>98&&(e=98),l(e)},300)}function r(){clearInterval(s),l(100),setTimeout(()=>{document.getElementById("progress-container").style.display="none"},500)}d.addEventListener("submit",function(e){e.preventDefault();const o=d.querySelector('button[type="submit"]');o.disabled=!0,o.style.opacity="0.5",o.style.cursor="not-allowed";const c=document.getElementById("subject").value,u=document.getElementById("grade").value,a=document.getElementById("unit").value,g=document.getElementById("details").value,m=document.getElementById("progress-container");m&&(m.style.display="block",m.scrollIntoView({behavior:"smooth",block:"center"})),t&&(t.style.display="none",t.innerHTML=""),n(),fetch(h,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject:c,grade:u,unit:a,details:g})}).then(i=>i.json()).then(i=>{if(r(),i.success){const f=new DOMParser().parseFromString(i.plan,"text/html"),y=f.querySelector("h3");y&&y.classList.add("lesson-plan-title"),t.innerHTML=f.body.innerHTML,t.style.display="block",t.scrollIntoView({behavior:"smooth",block:"start"});const p=document.createElement("button");p.textContent="下載 Word 檔案",p.id="downloadBtn",p.onclick=()=>v(i.html_content),t.appendChild(p)}else t.style.display="block",t.innerHTML=`<p>生成教案時出錯：${i.error}</p>`;o.disabled=!1,o.style.opacity="1",o.style.cursor="pointer"}).catch(i=>{r(),t.style.display="block",t.innerHTML=`<p>請求出錯：${i}</p>`,o.disabled=!1,o.style.opacity="1",o.style.cursor="pointer"})})});function v(d){const t=document.getElementById("progress-container"),s=t.querySelector(".loading-text"),l=s.textContent;t&&(s.textContent="正在準備您的 Word 檔案，請稍候...",t.style.display="block",t.scrollIntoView({behavior:"smooth",block:"center"}));let n=0;const r=setInterval(()=>{if(n<90){n+=Math.random()*10;const e=document.getElementById("progress-fill"),o=document.getElementById("progress-percent");e&&o&&(e.style.width=n+"%",o.textContent=Math.round(n)+"%")}},200);fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({html_content:d})}).then(e=>e.blob()).then(e=>{clearInterval(r);const o=document.getElementById("progress-fill"),c=document.getElementById("progress-percent");o&&c&&(o.style.width="100%",c.textContent="100%"),setTimeout(()=>{const u=window.URL.createObjectURL(e),a=document.createElement("a");a.style.display="none",a.href=u,a.download="lesson_plan.docx",document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(u),t.style.display="none",s.textContent=l},500)}).catch(e=>{clearInterval(r),console.error("Error downloading file:",e),t&&(t.style.display="none"),s.textContent=l,alert("下載失敗，請稍後再試。")})}
