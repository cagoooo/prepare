(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const t of n.addedNodes)t.tagName==="LINK"&&t.rel==="modulepreload"&&s(t)}).observe(document,{childList:!0,subtree:!0});function i(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=i(o);fetch(o.href,n)}})();const h="https://generateplan-gm5nfzzzwa-de.a.run.app",b="https://downloaddocx-gm5nfzzzwa-de.a.run.app";document.addEventListener("DOMContentLoaded",function(){"serviceWorker"in navigator&&(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&navigator.serviceWorker.getRegistrations().then(function(t){for(let r of t)r.unregister(),console.log("Service Worker 已註銷，確保載入最新版本 (localhost環境)。")});const c=document.getElementById("lesson-plan-form"),e=document.getElementById("result");let i;function s(t){const r=document.getElementById("progress-fill"),a=document.getElementById("progress-percent");r&&a&&(r.style.width=t+"%",a.textContent=Math.round(t)+"%")}function o(){let t=0;s(0),i=setInterval(()=>{t<30?t+=Math.random()*5:t<70?t+=Math.random()*2:t<95&&(t+=Math.random()*.5),t>98&&(t=98),s(t)},300)}function n(){clearInterval(i),s(100),setTimeout(()=>{document.getElementById("progress-container").style.display="none"},500)}c.addEventListener("submit",function(t){t.preventDefault();const r=c.querySelector('button[type="submit"]');r.disabled=!0,r.style.opacity="0.5",r.style.cursor="not-allowed";const a=document.getElementById("subject").value,m=document.getElementById("grade").value,y=document.getElementById("unit").value,g=document.getElementById("details").value,u=document.getElementById("progress-container");u&&(u.style.display="block",u.scrollIntoView({behavior:"smooth",block:"center"})),e&&(e.style.display="none",e.innerHTML=""),o(),fetch(h,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject:a,grade:m,unit:y,details:g})}).then(l=>l.json()).then(l=>{if(n(),l.success){const p=new DOMParser().parseFromString(l.plan,"text/html"),f=p.querySelector("h3");f&&f.classList.add("lesson-plan-title"),e.innerHTML=p.body.innerHTML,e.style.display="block",e.scrollIntoView({behavior:"smooth",block:"start"});const d=document.createElement("button");d.textContent="下載 Word 檔案",d.id="downloadBtn",d.onclick=()=>L(l.html_content),e.appendChild(d)}else e.style.display="block",e.innerHTML=`<p>生成教案時出錯：${l.error}</p>`;r.disabled=!1,r.style.opacity="1",r.style.cursor="pointer"}).catch(l=>{n(),e.style.display="block",e.innerHTML=`<p>請求出錯：${l}</p>`,r.disabled=!1,r.style.opacity="1",r.style.cursor="pointer"})})});function L(c){fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({html_content:c})}).then(e=>e.blob()).then(e=>{const i=window.URL.createObjectURL(e),s=document.createElement("a");s.style.display="none",s.href=i,s.download="lesson_plan.docx",document.body.appendChild(s),s.click(),window.URL.revokeObjectURL(i)}).catch(e=>{console.error("Error downloading file:",e)})}
